# 🎮 Horror Maze - 游戏设计文档

## 🎯 游戏核心概念

**类型**：第一人称恐怖迷宫逃生
**目标**：找到出口，坐车离开
**核心玩法循环**：
```
被鬼追逐（处境变差）
    ↓
触发"闪灵"看到前路（处境稍好）
    ↓
被逼近，选择躲藏
    ↓
等鬼走远，继续前进
    ↓
重复...直到找到出口
```

---

## 🔊 系统1：声音系统

### 声音来源
1. **玩家移动声**
   - 走路：小声
   - 跑步：大声
   - 蹲伏：极小声

2. **鬼的移动声**
   - 游走：正常音量
   - 追逐：急促脚步声

3. **环境声音**
   - 风声
   - 背景音乐
   - 出口处的车辆声（引导玩家）

4. **道具声音**（可选）
   - 打火机点燃声

### 声音属性
```cpp
struct Sound {
    sf::Vector2f position;     // 声音位置
    float volume;              // 音量大小
    float direction;           // 方向（相对玩家）
    float maxDistance;         // 最大传播距离
    bool isLooping;            // 是否循环播放
};
```

### 声音传播机制
- **距离衰减**：音量 = 基础音量 × (1 - 距离/最大距离)
- **方向计算**：左右耳音量差异（立体声效果）

### 声音可视化（声纹显示）
- **UI元素**：屏幕边缘显示声音方向指示器
- **表现形式**：
  ```
  ← ○ →   (左侧有声音)
    ○     (正前方有声音，大小用圆圈大小表示)
  ```

---

## 👻 系统2：鬼的行为逻辑（行为树）

### 鬼的状态机
```
游走 ⟷ 警戒 ⟷ 追逐
         ↓
      侦察（可选）
```

### 状态详细设计

#### 1️⃣ 游走状态（Patrol）
**触发条件**：
- 初始状态
- 追逐失败后回到游走

**行为**：
- 沿预设路径巡逻
- 移动速度：慢速（0.5 × 玩家走路速度）
- 发出脚步声（音量：中等）

**转换条件**：
- 听到玩家声音 → 警戒
- 看到玩家（距离 < 5格） → 追逐

#### 2️⃣ 警戒状态（Alert）
**触发条件**：
- 听到可疑声音
- 丢失玩家视线

**行为**：
- 停止移动，原地旋转
- 朝声音方向移动
- 持续时间：3-5秒

**转换条件**：
- 看到玩家 → 追逐
- 超时未发现 → 游走
- 听到新的声音 → 朝新方向警戒

#### 3️⃣ 追逐状态（Chase）
**触发条件**：
- 看到玩家
- 玩家距离 < 5格且发出声音

**行为**：
- 使用A*算法追踪玩家
- 移动速度：快速（0.9 × 玩家跑步速度）
- 发出急促脚步声（音量：大）
- 每0.5秒重新计算路径

**转换条件**：
- 抓到玩家（距离 < 0.5格） → 玩家死亡
- 丢失玩家超过10秒 → 警戒
- 玩家躲藏成功（视线阻挡） → 警戒

#### 4️⃣ 侦察状态（Investigate）（第二关添加）
**触发条件**：
- 发现玩家脚印（可选功能）

**行为**：
- 沿脚印路径移动
- 速度：中速

**转换条件**：
- 脚印消失 → 游走
- 看到玩家 → 追逐

### 行为树实现（简化版）
```cpp
class BehaviorTree {
    enum State { PATROL, ALERT, CHASE, INVESTIGATE };
    State currentState;

    void update(float deltaTime, const Player& player, const Maze& maze);
    void transitionTo(State newState);

    // 状态行为
    void patrol(float deltaTime);
    void alert(float deltaTime, sf::Vector2f soundDirection);
    void chase(float deltaTime, const Player& player);
};
```

### 视觉和听觉检测
```cpp
class Ghost {
    bool canSeePlayer(const Player& player, const Maze& maze);  // 视线检测
    bool canHearPlayer(const Player& player);                   // 听觉检测

    float hearingRange = 10.0f;  // 听觉范围
    float visionRange = 5.0f;    // 视觉范围
    float visionAngle = 60.0f;   // 视野角度（前方锥形）
};
```

---

## 🏃 系统3：玩家移动系统

### 3种移动方式
```cpp
enum class MoveMode {
    WALK,   // 走路
    RUN,    // 跑步
    CROUCH  // 蹲伏
};
```

### 移动属性对比
| 移动方式 | 速度 | 声音大小 | 体力消耗 | 用途 |
|---------|------|---------|----------|------|
| **走路** | 2.0 m/s | 小 | 无 | 安全探索 |
| **跑步** | 4.0 m/s | 大 | 中等 | 逃跑 |
| **蹲伏** | 1.0 m/s | 极小 | 无 | 潜行/躲藏 |

### 切换机制
- **走路 ⟷ 跑步**：按住 Shift 键
- **走路 ⟷ 蹲伏**：按住 Ctrl 键
- **平滑过渡**：速度插值变化（0.2秒过渡）

### 体力系统（可选）
```cpp
class Player {
    float stamina = 100.0f;     // 当前体力
    float maxStamina = 100.0f;  // 最大体力

    void updateStamina(float deltaTime, MoveMode mode);
    // 跑步：-20/秒
    // 走路/蹲伏：+10/秒恢复
};
```

---

## ✨ 系统4："闪灵"机制

### 触发条件
1. **鬼距离玩家 < 3格**（紧急情况）
2. **冷却时间**：30秒（避免滥用）

### 效果
- **视觉效果**：
  - 屏幕闪烁（白光）
  - 显示通往出口的路径（发光线条）
  - 持续时间：2-3秒

- **路径显示**：
  - 使用A*计算玩家到出口的最短路径
  - 在地面/墙上绘制发光轨迹
  - 颜色：蓝色/白色

### 实现
```cpp
class VisionAbility {
    bool isActive = false;
    float cooldown = 30.0f;
    float currentCooldown = 0.0f;
    float duration = 2.5f;
    std::vector<sf::Vector2i> pathToExit;

    void trigger(const Player& player, const Maze& maze);
    void update(float deltaTime);
    void render(sf::RenderWindow& window);
};
```

---

## 🧱 系统5：可交互环境

### 雪墙（Snow Wall）
**属性**：
```cpp
struct SnowWall {
    sf::Vector2i position;
    bool isIntact = true;        // 是否完好
    bool playerInside = false;   // 玩家是否躲藏其中
    float durability = 100.0f;   // 耐久度（鬼砸墙时减少）
};
```

**玩家交互**：
- **进入**：按 E 键躲进雪墙
- **效果**：
  - 视野变暗（从墙缝看外面）
  - 鬼无法直接看到玩家
  - 但打火机的光会透过墙

**鬼的交互**：
- **检测**：如果看到雪墙透光（玩家开打火机）
- **行为**：砸墙（5秒破坏）
- **结果**：玩家暴露，被抓住

### 陷阱（第二关）
1. **单向门**：只能从一个方向通过
2. **假墙**：看起来是墙，其实可以穿过
3. **移动地板**：缓慢移动玩家位置

---

## 🔦 系统6：打火机系统

### 功能
```cpp
class Lighter {
    bool isLit = false;          // 是否点燃
    float lightRadius = 5.0f;    // 照明半径
    float fuel = 100.0f;         // 燃料（秒）

    void toggle();               // 开关打火机
    void update(float deltaTime);
};
```

### 效果
**优点**：
- 照亮周围环境（黑暗中可见5格范围）
- 看清鬼的位置

**缺点**：
- **鬼会看到光源**（视觉检测距离 × 2）
- 如果躲在雪墙里开灯，鬼会发现（雪墙透光）
- 燃料有限（100秒）

### 使用场景
- 探索黑暗区域（必须使用）
- 紧急情况确认鬼的位置
- **风险决策**：开灯 = 看得清但会被发现

---

## 👯 敌人设计：双胞胎鬼魂

### 第一关：静止双胞胎
**位置**：固定在迷宫某处
**外观**：两个相同的小女孩（经典恐怖元素）

**行为**：
- 不移动，不追逐
- 玩家靠近时（距离 < 2格）触发

**触发效果**：
1. 播放恐怖语音（"一起玩吧..."）
2. 硬控玩家（无法移动）
3. 持续时间：3秒
4. **后果**：如果鬼在追你，会被抓住

**设计意图**：
- 增加恐怖氛围
- 路径陷阱（必须选择绕路或冒险通过）

### 第二关：移动双胞胎（可选）
- 会缓慢游走
- 其他机制相同

---

## 🗺️ 关卡设计

### 第一关：雪地迷宫
**地图**：
- 大小：20×20格
- 类型：固定地图（手工设计）
- 主题：雪地森林

**布局要素**：
```
S = 起点（Start）
E = 出口（Exit）
G = 鬼的初始位置（Ghost）
T = 双胞胎（Twins）
W = 雪墙（Wall - 可躲藏）
L = 打火机（Lighter）
```

**示例地图**（简化）：
```
██████████████████████
█ S     █       █  W █
█ ███   █   T   █    █
█   █   █       ███  █
█   █   ██████  █    █
█ W     █    █  █    █
█ ████  █ L  █  ███  █
█    █       █     G █
█    ██████████████  █
█ W             █    █
█   ███   ███   █  E █
██████████████████████
```

**目标**：
- 在迷宫中找到打火机
- 避开双胞胎
- 躲避鬼的追踪
- 到达出口

**胜利条件**：
- 到达出口（E点）
- 触发胜利动画（坐车离开）

**失败条件**：
- 被鬼抓住

### 第二关（时间允许）
- 添加陷阱
- 添加移动双胞胎
- 增加鬼的数量或难度

---

## 🎨 美术风格

### 视觉风格
**关键词**：电影感、简约、恐怖

**色调**：
- 主色：深蓝、黑色、白色（雪地）
- 强调：红色（危险）、蓝色（闪灵效果）

**环境**：
- 雪地迷宫（墙体：白色/灰色）
- 黑暗环境（需要打火机照明）
- 雾效（可选，增加恐怖感）

### UI设计
**极简原则**：
- 主菜单：
  ```
  HORROR MAZE

  [开始游戏]
  [退出]
  ```

- HUD（游戏中）：
  - 左上角：打火机燃料条
  - 右上角：声音指示器
  - 下方：闪灵冷却时间
  - **无**血条、分数等复杂元素

### 图形实现
**3D效果**：
- 使用光线投射（Raycasting）
- 墙体：简单颜色块（不需要纹理）
- 鬼：红色轮廓/形状
- 双胞胎：两个并排的人形轮廓

**光照**：
- 全局黑暗（环境光很低）
- 打火机：点光源（圆形渐变）
- 闪灵：全屏闪烁 + 路径发光

---

## 🎮 操作方案

### 键盘控制
```
W/↑     - 前进
S/↓     - 后退
A/←     - 左转
D/→     - 右转
Shift   - 奔跑（按住）
Ctrl    - 蹲伏（按住）
F       - 打火机开关
E       - 交互（躲进雪墙）
Tab     - 切换俯视图/第一人称（调试用）
ESC     - 暂停菜单
```

### 控制感觉
- 移动：流畅，有惯性
- 转向：中等速度（不要太快，增加紧张感）
- 躲藏：有0.5秒动画（进入/离开雪墙）

---

## 📊 游戏数据平衡

### 速度设置
```cpp
const float PLAYER_WALK_SPEED = 2.0f;    // 走路速度
const float PLAYER_RUN_SPEED = 4.0f;     // 跑步速度
const float PLAYER_CROUCH_SPEED = 1.0f;  // 蹲伏速度
const float GHOST_PATROL_SPEED = 1.0f;   // 鬼游走速度
const float GHOST_CHASE_SPEED = 3.5f;    // 鬼追逐速度（比玩家跑步慢一点）
```

### 音量设置
```cpp
const float SOUND_WALK = 0.3f;      // 走路音量
const float SOUND_RUN = 1.0f;       // 跑步音量
const float SOUND_CROUCH = 0.1f;    // 蹲伏音量
const float SOUND_GHOST = 0.7f;     // 鬼的脚步声
```

### 时间设置
```cpp
const float VISION_COOLDOWN = 30.0f;      // 闪灵冷却
const float VISION_DURATION = 2.5f;       // 闪灵持续时间
const float TWINS_STUN_DURATION = 3.0f;   // 双胞胎硬控时间
const float GHOST_LOSE_TRACK_TIME = 10.0f;// 鬼丢失目标时间
const float LIGHTER_FUEL = 100.0f;        // 打火机燃料（秒）
```

### 距离设置
```cpp
const float GHOST_VISION_RANGE = 5.0f;        // 鬼视野距离
const float GHOST_HEARING_RANGE = 10.0f;      // 鬼听觉距离
const float LIGHTER_LIGHT_RADIUS = 5.0f;      // 打火机照明半径
const float TWINS_TRIGGER_DISTANCE = 2.0f;    // 双胞胎触发距离
const float VISION_TRIGGER_DISTANCE = 3.0f;   // 闪灵触发距离
```

---

## 🚀 开发优先级

### P0 - 核心功能（必须实现）
1. ✅ 基础移动（走路）
2. ✅ 迷宫系统（固定地图）
3. ✅ 第一人称渲染
4. ✅ 鬼的基础AI（游走、追逐）
5. ✅ 碰撞检测
6. ✅ 胜利/失败判定
7. ✅ 基础UI（菜单、HUD）

### P1 - 重要功能（应该实现）
1. ✅ 3种移动方式（走/跑/蹲）
2. ✅ 声音系统（基础）
3. ✅ 打火机照明
4. ✅ 雪墙躲藏
5. ✅ 双胞胎鬼魂
6. ✅ "闪灵"机制
7. ✅ 行为树AI（完整）

### P2 - 加分功能（时间允许）
1. ⭐ 声音可视化（声纹）
2. ⭐ 体力系统
3. ⭐ 音效（脚步声、环境音）
4. ⭐ 光照效果优化
5. ⭐ 第二关卡
6. ⭐ 陷阱系统
7. ⭐ 脚印侦察

---

## 🎬 玩家体验时间线（理想流程）

**0:00 - 开始游戏**
- 主菜单 → 按Enter开始
- 淡入到迷宫起点

**0:10 - 探索阶段**
- 玩家慢慢走，熟悉操作
- 找到打火机
- 看到双胞胎（远远避开）

**0:30 - 紧张阶段**
- 鬼听到声音，开始警戒
- 玩家意识到有危险
- 尝试蹲伏前进

**0:50 - 追逐阶段**
- 不小心被鬼看到
- 开始奔跑逃离
- 体验"被追逐"的恐惧

**1:10 - 闪灵阶段**
- 鬼逼近，触发闪灵
- 看到通往出口的路径
- 获得希望

**1:30 - 躲藏阶段**
- 被逼入绝境
- 躲进雪墙
- 屏住呼吸等鬼离开

**1:50 - 冲刺阶段**
- 鬼走远，冲出雪墙
- 全速奔向出口
- 心跳加速

**2:00 - 胜利！**
- 到达出口
- 胜利动画（坐车离开）

**目标时长**：2-3分钟完成一局

---

## 📝 技术备注

### SFML音频使用
```cpp
#include <SFML/Audio.hpp>

sf::Sound footstepSound;
sf::SoundBuffer buffer;
buffer.loadFromFile("footstep.wav");
footstepSound.setBuffer(buffer);
footstepSound.setVolume(50);  // 0-100
footstepSound.play();
```

### 行为树简化实现
- 不需要完整的行为树框架
- 使用状态机 + 条件判断即可
- 重点是状态转换逻辑清晰

### 光线投射优化
- 不需要纹理贴图（用纯色即可）
- 重点是墙体渲染和光照效果
- 参考 Lode's Raycasting Tutorial

---

**文档版本**：v2.0
**更新日期**：2024-12-21
**状态**：设计确认 ✅

